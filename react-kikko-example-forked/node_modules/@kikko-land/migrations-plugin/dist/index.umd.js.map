{"version":3,"file":"index.umd.js","sources":["../src/migrationPlugin.ts"],"sourcesContent":["import {\n  IDbClientPlugin,\n  IDbState,\n  runInTransaction,\n  runQuery,\n} from \"@kikko-land/kikko\";\nimport { generateInsert, sql } from \"@kikko-land/sql\";\n\nimport { IMigration } from \"./types\";\n\nconst migrationsTable = \"migrations\";\n\nconst runMigrations = (state: IDbState, migrations: IMigration[]) => {\n  if (migrations.length === 0) return;\n\n  return runInTransaction(state, async (state) => {\n    await runQuery(\n      state,\n      sql`\n        CREATE TABLE IF NOT EXISTS ${sql.raw(migrationsTable)} (\n          id INTEGER PRIMARY KEY,\n          name varchar(20) NOT NULL,\n          migratedAt INTEGER NOT NULL\n        )\n      `\n    );\n\n    const migratedMigrations = await runQuery<{ id: number }>(\n      state,\n      sql`SELECT id FROM ${sql.raw(migrationsTable)}`\n    );\n\n    const migratedIds = new Set(migratedMigrations.map(({ id }) => id));\n\n    for (const migration of migrations.sort((a, b) => a.id - b.id)) {\n      if (migratedIds.has(migration.id)) return;\n\n      await migration.up(state);\n\n      await runQuery(\n        state,\n        generateInsert(migrationsTable, [\n          {\n            id: migration.id,\n            name: migration.name,\n            migratedAt: new Date().getTime(),\n          },\n        ])\n      );\n    }\n  });\n};\n\nexport const migrationsPlugin = ({\n  migrations,\n}: {\n  migrations: IMigration[];\n}): IDbClientPlugin => (state: IDbState) => {\n  state.sharedState.eventsEmitter.on(\"initialized\", async () => {\n    await runMigrations(state, migrations);\n  });\n\n  return state;\n};\n"],"names":["runInTransaction","runQuery","sql","generateInsert"],"mappings":"8VAUA,KAAM,GAAkB,aAElB,EAAgB,CAAC,EAAiB,IAA6B,CACnE,GAAI,EAAW,SAAW,EAEnB,MAAAA,GAAA,iBAAiB,EAAO,KAAO,IAAU,CAC9C,KAAMC,YACJ,EACAC;qCAC+BA,EAAA,IAAI,IAAI,CAAe;AAAA;AAAA;AAAA;AAAA;AAAA,OAMxD,EAEM,KAAA,GAAqB,KAAMD,YAC/B,EACAC,uBAAqBA,EAAAA,IAAI,IAAI,CAAe,GAC9C,EAEM,EAAc,GAAI,KAAI,EAAmB,IAAI,CAAC,CAAE,QAAS,CAAE,CAAC,EAEvD,SAAA,KAAa,GAAW,KAAK,CAAC,EAAG,IAAM,EAAE,GAAK,EAAE,EAAE,EAAG,CAC1D,GAAA,EAAY,IAAI,EAAU,EAAE,EAAG,OAE7B,KAAA,GAAU,GAAG,CAAK,EAElB,KAAAD,YACJ,EACAE,EAAA,eAAe,EAAiB,CAC9B,CACE,GAAI,EAAU,GACd,KAAM,EAAU,KAChB,WAAY,GAAI,MAAK,EAAE,QAAQ,CACjC,CACD,CAAA,CACH,CACF,CAAA,CACD,CACH,EAEa,EAAmB,CAAC,CAC/B,gBAGqB,AAAC,GACtB,GAAM,YAAY,cAAc,GAAG,cAAe,SAAY,CACtD,KAAA,GAAc,EAAO,CAAU,CAAA,CACtC,EAEM"}