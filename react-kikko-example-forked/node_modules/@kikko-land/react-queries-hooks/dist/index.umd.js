(function(u,o){typeof exports=="object"&&typeof module!="undefined"?o(exports,require("@kikko-land/kikko"),require("react"),require("@kikko-land/reactive-queries-plugin")):typeof define=="function"&&define.amd?define(["exports","@kikko-land/kikko","react","@kikko-land/reactive-queries-plugin"],o):(u=typeof globalThis!="undefined"?globalThis:u||self,o(u.core={},u.kikko,u.React,u.reactiveQueriesPlugin))})(this,function(u,o,n,C){"use strict";function L(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}var h=L(n);const v=h.default.createContext({type:"notInitialized"}),m=({children:e,config:t})=>{const[i,r]=n.useState({type:"notInitialized"});return n.useEffect(()=>{let s=!1,d;return(async()=>{r({type:"initializing",config:t});const f=await o.initDbClient(t);if(d=f,s){o.stopDb(f);return}r({type:"initialized",db:f,config:t})})(),()=>{s=!0,d&&(r({type:"notInitialized"}),o.stopDb(d))}},[t]),h.default.createElement(v.Provider,{value:i},e)},p=()=>n.useContext(v),w=()=>{const e=p();if(e.type==="initialized")return e.db},M=()=>{const e=w();if(!e)throw new Error("DB is not initialized!");return e},T=({children:e,fallback:t})=>p().type==="initialized"?e:t||null;function g(e,t){const i=p(),{suppressLog:r}={suppressLog:(t==null?void 0:t.suppressLog)!==void 0?t.suppressLog:!1},[s,d]=n.useState(e||[]),[l,f]=n.useState(),[b,c]=n.useState(e?i.type==="initialized"?{type:"loading"}:{type:"waitingDb"}:{type:"noSqlPresent"});return n.useEffect(()=>{if(s.length===0){c({type:"noSqlPresent"});return}if(i.type!=="initialized"){c({type:"waitingDb"});return}const a=r?o.withSuppressedLog(i.db):i.db,y=C.listenQueries(a,s).subscribe(D=>{f(D),c({type:"loaded"})});return()=>{y.unsubscribe()}},[i,s,r]),n.useEffect(()=>{s.map(a=>a.toSql().hash).join()!==(e||[]).map(a=>a.toSql().hash).join()&&d(e||[])},[s,e]),n.useMemo(()=>{if(b.type==="loaded"){if(!l)throw new Error("Internal error: response state is loaded, but there is not data!");return{...b,data:l}}return{...b,data:l||[]}},[l,b])}function z(e,t){const i=n.useMemo(()=>e?[e]:[],[e]),r=g(i,t);return n.useMemo(()=>{var s;if(r.type==="loaded"){if(!r.data)throw new Error("Internal error: response state is loaded, but there is not data!");return{...r,data:r.data[0]||[]}}return{...r,data:((s=r.data)==null?void 0:s[0])||[]}},[r])}function k(e,t){const i=z(e,t);return n.useMemo(()=>{var r;return i.type==="loaded"?{...i,data:i.data[0]}:{...i,data:(r=i.data)==null?void 0:r[0]}},[i])}function I(){const e=n.useRef(!1);return n.useEffect(()=>(e.current=!0,()=>{e.current=!1}),[]),n.useCallback(()=>e.current,[])}function P(e,t){const{suppressLog:i,inTransaction:r}={suppressLog:(t==null?void 0:t.suppressLog)!==void 0?t.suppressLog:!1,inTransaction:(t==null?void 0:t.inTransaction)!==void 0?t.inTransaction:!0},s=p(),d=I(),[l,f]=n.useState(),[b,c]=n.useState(s.type==="initialized"?"idle":"waitingDb");n.useEffect(()=>{s.type==="initialized"?c("idle"):c("waitingDb")},[s.type]);const a=n.useCallback(async(...S)=>{if(s.type!=="initialized")throw new Error("Db not initialized!");c("running");const Q=i?o.withSuppressedLog(s.db):s.db,E=await(r?o.runInTransaction(Q,B=>e(B)(...S)):e(Q)(...S));return d()&&(f(E),c("done")),E},[e,s,r,d,i]),y=n.useRef(a);n.useEffect(()=>{y.current=a},[a]);const D=n.useCallback((...S)=>y.current(...S),[]),q=n.useMemo(()=>({type:b,data:l}),[l,b]);return[D,q]}function j(e){const[t,i]=n.useState(e);return n.useEffect(()=>{t.toSql().hash!==e.toSql().hash&&i(e)},[e,t]),t}u.DbProvider=m,u.EnsureDbLoaded=T,u.useCacheQuery=j,u.useDb=w,u.useDbState=p,u.useDbStrict=M,u.useQueries=g,u.useQuery=z,u.useQueryFirstRow=k,u.useRunQuery=P,Object.defineProperties(u,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=index.umd.js.map
